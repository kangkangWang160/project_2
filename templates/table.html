<!doctype html>
<html>
<head>
    <title>Poker Table</title>
    <style>
        body { background: radial-gradient(circle at 50% 40%, #228B22 60%, #006400 100%); color: #fff; font-family: 'Segoe UI', sans-serif; margin: 0; min-height: 100vh; display: flex; flex-direction: column; }
        .table-area { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; }
        .ai-section { position: absolute; top: 40px; left: 0; right: 0; display: flex; flex-direction: column; align-items: center; }
        .community-section { position: absolute; top: 75%; left: 0; right: 0; transform: translateY(-25%); display: flex; flex-direction: column; align-items: center; }
        .cards { display: flex; gap: 18px; justify-content: center; }
        .card-img { height: 120px; border-radius: 10px; box-shadow: 0 4px 16px #000a; background: #fff3; }
        .section-title { text-align: center; letter-spacing: 2px; font-weight: 600; text-shadow: 0 2px 8px #000a; }
        .bottom-section { margin-top: auto; margin-bottom: 40px; width: 100%; display: flex; flex-direction: column; align-items: center; }
        .btn { background: #fff; color: #006400; border: none; padding: 12px 32px; border-radius: 8px; font-size: 1.2em; font-weight: 600; cursor: pointer; margin: 10px; box-shadow: 0 2px 8px #0004; transition: background 0.2s; }
        .btn:hover { background: #e0ffe0; }
        .nav-btns { display: flex; gap: 20px; justify-content: center; margin-top: 18px; }
        /* Side panel styles */
        .side-panel-btn, .points-panel-btn { position: fixed; top: 30px; z-index: 1001; background: #fff; color: #006400; border: none; border-radius: 50%; width: 56px; height: 56px; font-size: 2em; font-weight: bold; box-shadow: 0 2px 8px #0004; cursor: pointer; transition: background 0.2s; display: flex; align-items: center; justify-content: center; }
        .side-panel-btn { right: 30px; }
        .points-panel-btn { left: 30px; }
        .token-btn { right: 100px; width: 80px; height: 56px; border-radius: 28px; color: #fff; background: #ffe066; font-weight: 700; box-shadow: 0 2px 8px #0004; pointer-events: none; padding: 0; display: flex; align-items: center; justify-content: center; }
        .token-img { height: 36px; margin-right: 8px; vertical-align: middle; }
        .token-number { font-size: 1em; color: #b8860b; font-weight: 700; }
        .side-panel-btn:hover, .points-panel-btn:hover { background: #e0ffe0; }
        .side-panel, .points-panel { position: fixed; top: 0; width: 350px; height: 100vh; background: #1a3d1a; color: #fff; box-shadow: 4px 0 16px #000a; z-index: 1002; transition: left 0.3s cubic-bezier(.4,2,.6,1), right 0.3s cubic-bezier(.4,2,.6,1); padding: 36px 28px 28px 28px; overflow-y: auto; }
        .side-panel { right: -400px; transition: right 0.3s cubic-bezier(.4,2,.6,1); }
        .side-panel.open { right: 0; }
        .points-panel { left: -400px; box-shadow: -4px 0 16px #000a; transition: left 0.3s cubic-bezier(.4,2,.6,1); }
        .points-panel.open { left: 0; }
        .side-panel h2, .points-panel h2 { margin-top: 0; text-align: left; }
        .side-panel-close, .points-panel-close { position: absolute; top: 18px; right: 18px; background: none; border: none; color: #fff; font-size: 1.5em; cursor: pointer; }
        .points-panel-close { left: 18px; right: auto; }
        .hand-example { margin-bottom: 18px; }
        .hand-title { font-weight: bold; color: #baffba; }
        .hand-desc { font-size: 1em; color: #fff; }
    </style>
</head>
<body>
    <a href="/" style="position: fixed; top:30px; left:110px; z-index:2000; text-decoration:none;">
        <button class="btn" style="margin:0; padding:10px 24px; font-size:1em; border-radius:8px;">Home</button>
    </a>
    <button class="points-panel-btn" onclick="document.getElementById('pointsPanel').classList.add('open')">&#9876;</button>
    <button class="side-panel-btn" onclick="document.getElementById('sidePanel').classList.add('open')">?</button>
    <div id="game-status" style="position:fixed; top:0; left:50%; transform:translateX(-50%); width:50vw; background:#1a3d1a; color:#fff; font-size:1.1em; text-align:center; padding:14px 0 8px 0; z-index:1500; box-shadow:0 2px 8px #000a; border-radius:0 0 18px 18px; display:flex; align-items:center; justify-content:center;">
        <span id="status-text" style="flex:1;">Welcome to Texas Hold'em! Place your bet to start the round.</span>
        <button id="next-btn" class="btn" style="margin-left:10px; background:#ffe066; color:#006400; font-weight:700; font-size:1.1em; border-radius:50%; width:38px; height:38px; box-shadow:0 2px 8px #0004; display:none;">Next</button>
        <button id="terms-btn" title="Poker Terms" style="margin-left:18px; background:#ffe066; color:#006400; border:none; border-radius:50%; width:38px; height:38px; font-size:1.3em; font-weight:bold; cursor:pointer; box-shadow:0 2px 8px #0004; display:none;">?</button>
    </div>
    <div id="bet-status" style="position:fixed; top:60px; left:50%; transform:translateX(-50%); width:50vw; background:#1a3d1a; color:#fff; font-size:1.1em; text-align:center; padding:14px 0 8px 0; z-index:1501; box-shadow:0 2px 8px #000a; border-radius:0 0 18px 18px; display:none; overflow:hidden; white-space:nowrap; text-overflow:ellipsis;"></div>
    <div id="terms-modal" style="display:none; position:fixed; top:70px; left:50%; transform:translateX(-50%); background:#1a3d1a; color:#fff; border-radius:14px; box-shadow:0 2px 16px #000a; z-index:2001; padding:28px 32px; min-width:320px; max-width:90vw;">
        <h3 style="margin-top:0; color:#ffe066;">Poker Terms</h3>
        <ul id="terms-list" style="font-size:1.1em; line-height:1.7; padding-left:18px;"></ul>
        <button onclick="document.getElementById('terms-modal').style.display='none'" style="margin-top:18px; background:#ffe066; color:#006400; border:none; border-radius:8px; padding:8px 22px; font-size:1em; font-weight:600; cursor:pointer;">Close</button>
    </div>
    <div id="sidePanel" class="side-panel">
        <button class="side-panel-close" onclick="document.getElementById('sidePanel').classList.remove('open')">&times;</button>
        <h2>Instructions</h2>
        <div style="font-size:1.1em;line-height:1.6;">
            <p><strong>Texas Hold'em Poker</strong> is a popular card game. Each player is dealt two cards, and five community cards are placed face up. Make the best five-card hand using any combination of your cards and the community cards.</p>
            <ul>
                <li>Your hand is shown at the bottom.</li>
                <li>The AI's hand is hidden until showdown.</li>
                <li>The community pool is in the center.</li>
            </ul>
            <p>For more details, see the full rules online!</p>
        </div>
    </div>
    <div id="pointsPanel" class="points-panel">
        <button class="points-panel-close" onclick="document.getElementById('pointsPanel').classList.remove('open')">&times;</button>
        <h2>Poker Hand Rankings</h2>
        <div style="font-size:1.1em;line-height:1.6;">
            <div class="hand-example"><span class="hand-title">Royal Flush</span><br><span class="hand-desc">A, K, Q, J, 10, all the same suit. <br>Example: A♠ K♠ Q♠ J♠ 10♠</span></div>
            <div class="hand-example"><span class="hand-title">Straight Flush</span><br><span class="hand-desc">Five cards in a sequence, all the same suit. <br>Example: 9♥ 8♥ 7♥ 6♥ 5♥</span></div>
            <div class="hand-example"><span class="hand-title">Four of a Kind</span><br><span class="hand-desc">Four cards of the same rank. <br>Example: 4♣ 4♠ 4♦ 4♥ 9♠</span></div>
            <div class="hand-example"><span class="hand-title">Full House</span><br><span class="hand-desc">Three of a kind and a pair. <br>Example: 8♠ 8♦ 8♣ 2♥ 2♠</span></div>
            <div class="hand-example"><span class="hand-title">Flush</span><br><span class="hand-desc">Any five cards of the same suit. <br>Example: K♣ 10♣ 7♣ 6♣ 2♣</span></div>
            <div class="hand-example"><span class="hand-title">Straight</span><br><span class="hand-desc">Five cards in a sequence. <br>Example: 5♠ 4♦ 3♣ 2♥ A♠</span></div>
            <div class="hand-example"><span class="hand-title">Three of a Kind</span><br><span class="hand-desc">Three cards of the same rank. <br>Example: Q♠ Q♦ Q♣ 7♣ 2♥</span></div>
            <div class="hand-example"><span class="hand-title">Two Pair</span><br><span class="hand-desc">Two different pairs. <br>Example: J♠ J♦ 8♣ 8♥ 3♠</span></div>
            <div class="hand-example"><span class="hand-title">One Pair</span><br><span class="hand-desc">Two cards of the same rank. <br>Example: 6♣ 6♠ Q♦ 9♥ 3♣</span></div>
            <div class="hand-example"><span class="hand-title">High Card</span><br><span class="hand-desc">When you haven't made any of the hands above. <br>Example: A♣ J♦ 8♠ 6♥ 3♣</span></div>
        </div>
    </div>
    <div class="table-area">
        <div class="ai-section">
            <div id="ai-bet-bar" style="display:flex; align-items:center; justify-content:center; gap:10px;">
                <h2 class="section-title" style="margin-bottom:0;">AI Hand</h2>
                <!-- AI bet display will be shown here after player checks -->
            </div>
            <div class="cards">
                <img class="card-img" src="{{ url_for('custom_cards', filename='cardback.jpg') }}" alt="Hidden">
                <img class="card-img" src="{{ url_for('custom_cards', filename='cardback.jpg') }}" alt="Hidden">
            </div>
        </div>
        <div class="community-section">
            <div class="cards" id="community-cards">
                <img class="card-img" src="{{ url_for('custom_cards', filename='cards.png') }}" alt="Community Pool">
            </div>
        </div>
    </div>
    <div class="bottom-section" style="position:relative;">
        <div class="cards">
            {% for card in player_hand %}
                <img class="card-img" src="{{ url_for('custom_cards', filename=card_filename(card)) }}" alt="{{ card['rank'] }} of {{ card['suit'] }}">
            {% endfor %}
        </div>
        <div style="display:flex; align-items:center; justify-content:center; gap:10px; margin-top:18px;">
            <h2 class="section-title" style="margin:0;">Your Hand</h2>
            <span style="display:flex; align-items:center; gap:6px; margin-left:10px;">
                <img src="{{ url_for('custom_cards', filename='token.png') }}" alt="Token" style="height:28px;">
                <span style="font-size:1.1em; color:#ffe066; font-weight:700;">{{ player_bet }}</span>
            </span>
        </div>
        <div style="position:absolute; left:30px; bottom:30px; display:flex; align-items:center; gap:8px; background:#ffe066; border-radius:18px; box-shadow:0 2px 8px #0004; padding:6px 14px;">
            <img class="token-img" src="{{ url_for('custom_cards', filename=token_img) }}" alt="Token" style="height:24px; margin-right:6px; vertical-align:middle;">
            <span class="token-number" style="font-size:1.1em; color:#b8860b; font-weight:700;">{{ tokens }}</span>
        </div>
        <form id="bet-form" style="position:fixed; top:120px; right:40px; width:320px; background:#1a3d1a; border-radius:14px; box-shadow:0 2px 12px #000a; padding:24px 18px; display:flex; flex-direction:column; align-items:center; gap:18px; z-index:1200;" onsubmit="return submitBet(event)">
            <label for="player_bet" style="font-size:1.2em; color:#fff;">How many tokens do you want to bet?</label>
            <input type="number" id="player_bet" name="player_bet" min="1" max="{{ tokens }}" value="1" style="width:80px; font-size:1.2em; padding:6px 10px; border-radius:6px; border:1px solid #ccc;">
            <div style="display:flex; gap:10px; width:100%; justify-content:center;">
                <button type="submit" id="bet-btn" class="btn" style="background:#2ecc40; color:#fff;">{{ 'Call' if call_amount and call_amount > 0 else 'Bet' }}</button>
                <button type="button" id="all-in-btn" class="btn" style="background:#ffb347; color:#006400; font-weight:700;">All In</button>
                <button type="button" id="forfeit-btn" class="btn" style="background:#ff4d4d; color:#fff; font-weight:700;">Forfeit</button>
            </div>
        </form>
    </div>
    <div style="position:fixed; top:100px; left:30px; z-index:1100; display:flex; align-items:center; gap:10px; background:#ffe066; border-radius:18px; box-shadow:0 2px 8px #0004; padding:10px 18px; min-width:170px;">
        <img class="token-img" src="{{ url_for('custom_cards', filename=token_img) }}" alt="Token" style="height:28px; margin-right:8px; vertical-align:middle;">
        <span class="token-number" style="font-size:1.1em; color:#b8860b; font-weight:700;">{{ ai_tokens }}</span>
        <span style="font-size:1.1em; color:#006400; font-weight:600; margin-left:6px;">AI tokens left</span>
    </div>
    <div id="stake-box" style="position:fixed; top:70px; right:40px; left:auto; transform:none; background:#ffe066; color:#006400; border-radius:10px; box-shadow:0 2px 8px #0004; padding:8px 24px; font-size:1.2em; font-weight:700; z-index:1400; display:flex; align-items:center; gap:10px;">
        <span>Stake:</span>
        <span id="stake-amount">{{ player_bet|default(0) + ai_bet|default(0) }}</span>
        <img src="{{ url_for('custom_cards', filename='token.png') }}" alt="Token" style="height:22px; margin-left:4px;">
    </div>
    <script>
        function showTermsButtonIfNeeded() {
            const statusText = document.getElementById('status-text').textContent.toLowerCase();
            const terms = ['check', 'bet', 'call', 'raise', 'fold'];
            const btn = document.getElementById('terms-btn');
            btn.style.display = terms.some(term => statusText.includes(term)) ? '' : 'none';
        }
        function showRelevantTerms() {
            const statusText = document.getElementById('status-text').textContent.toLowerCase();
            const definitions = {
                check: '<b>Check</b>: To pass the action to the next player without betting. <br><span style="color:#ffe066;">You can only check if no previous player has bet during that round of betting. If someone has bet, you must either call, raise, or fold.</span>',
                bet: '<b>Bet</b>: To place chips/tokens into the pot for the first time in a round.',
                call: '<b>Call</b>: To match the current highest bet made by another player.',
                raise: '<b>Raise</b>: To increase the current bet by adding more chips/tokens.',
                fold: '<b>Fold</b>: To give up your hand and forfeit the round.'
            };
            const termsList = document.getElementById('terms-list');
            termsList.innerHTML = '';
            let any = false;
            for (const term in definitions) {
                if (statusText.includes(term)) {
                    const li = document.createElement('li');
                    li.innerHTML = definitions[term];
                    termsList.appendChild(li);
                    any = true;
                }
            }
            if (!any) {
                const li = document.createElement('li');
                li.textContent = 'No poker terms to define.';
                termsList.appendChild(li);
            }
        }
        function updateBetButtonText(callAmount) {
            const betBtn = document.getElementById('bet-btn');
            if (betBtn) {
                betBtn.textContent = (callAmount && callAmount > 0) ? 'Call' : 'Bet';
            }
        }
        function showNextButton() {
            const nextBtn = document.getElementById('next-btn');
            if (nextBtn) nextBtn.style.display = '';
        }
        function hideNextButton() {
            const nextBtn = document.getElementById('next-btn');
            if (nextBtn) nextBtn.style.display = 'none';
        }
        function updateStakeBox(playerBet, aiBet) {
            const stakeAmount = document.getElementById('stake-amount');
            if (stakeAmount) {
                stakeAmount.textContent = Number(playerBet) + Number(aiBet);
            }
        }
        function submitBet(event) {
            event.preventDefault();
            const bet = document.getElementById('player_bet').value;
            fetch('/bet', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ player_bet: bet })
            })
            .then(response => response.json())
            .then(data => {
                const betStatus = document.getElementById('bet-status');
                if (data.error) {
                    if (betStatus) {
                        betStatus.textContent = data.error;
                        betStatus.style.display = '';
                    }
                    const statusText = document.getElementById('status-text');
                    if (statusText) statusText.textContent = data.error;
                } else {
                    if (betStatus) {
                        betStatus.textContent = '';
                        betStatus.style.display = 'none';
                    }
                    // Only update status if the element exists
                    const betStatusElem = document.getElementById('bet-status');
                    if (betStatusElem) betStatusElem.textContent = '';
                    const statusText = document.getElementById('status-text');
                    if (statusText) {
                        let aiActionText = '';
                        if (data.ai_bet > 0) {
                            aiActionText = `AI bet ${data.ai_bet} tokens.`;
                        } else {
                            aiActionText = 'AI calls.';
                        }
                        statusText.textContent = `You bet ${bet} tokens. ${aiActionText}`;
                    }
                    // Update token counts and bet amounts on the page without reload
                    document.querySelectorAll('.token-number')[0].textContent = data.tokens;
                    document.querySelectorAll('.token-number')[1].textContent = data.ai_tokens;
                    document.querySelectorAll('span[style*="color:#ffe066"]')[0].textContent = data.player_bet;
                    // Update the player's bet display next to the token image
                    const playerBetSpans = document.querySelectorAll('.bottom-section span[style*="color:#ffe066"]');
                    if (playerBetSpans.length > 0) {
                        playerBetSpans[0].textContent = data.player_bet;
                    }
                    // Show AI bet next to AI Hand
                    const aiBetBar = document.getElementById('ai-bet-bar');
                    let aiBetDisplay = document.getElementById('ai-bet-display');
                    if (!aiBetDisplay) {
                        aiBetDisplay = document.createElement('span');
                        aiBetDisplay.id = 'ai-bet-display';
                        aiBetDisplay.style.display = 'flex';
                        aiBetDisplay.style.alignItems = 'center';
                        aiBetDisplay.style.gap = '6px';
                        aiBetDisplay.style.marginLeft = '10px';
                        aiBetBar.appendChild(aiBetDisplay);
                    }
                    if (data.ai_bet > 0) {
                        aiBetDisplay.innerHTML = `<img src="/cards/token.png" alt="Token" style="height:28px;"> <span style="font-size:1.1em; color:#ffe066; font-weight:700;">${data.ai_bet}</span>`;
                    } else {
                        aiBetDisplay.innerHTML = '';
                    }
                    // Hide the bet form after player checks
                    document.getElementById('bet-form').style.display = 'none';
                    // Show the Next button after a successful bet
                    showNextButton();
                    // Update the stake box
                    updateStakeBox(data.player_bet, data.ai_bet);
                }
                // Update bet button text based on call amount
                updateBetButtonText(data.call_amount);
                showTermsButtonIfNeeded();
            });
            return false;
        }
        // Initial set for bet button text
        updateBetButtonText(0);
        // Initial set for stake box
        updateStakeBox(0, 0);
        // Initial check for terms button
        showTermsButtonIfNeeded();
        // Close side panels on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                document.getElementById('sidePanel').classList.remove('open');
                document.getElementById('pointsPanel').classList.remove('open');
            }
        });
        document.getElementById('terms-btn').onclick = function() {
            showRelevantTerms();
            document.getElementById('terms-modal').style.display = 'block';
        };
        document.getElementById('next-btn').onclick = function() {
            // Move the burn card (cardback) to the far left edge and deal 3 random community cards
            const communityCards = document.getElementById('community-cards');
            // Remove all existing cards (including placeholder or previous round)
            while (communityCards.firstChild) {
                communityCards.removeChild(communityCards.firstChild);
            }
            // Add burn card to the far left edge
            const burnCard = document.createElement('img');
            burnCard.className = 'card-img';
            burnCard.src = "{{ url_for('custom_cards', filename='cardback.jpg') }}";
            burnCard.alt = 'Burn Card';
            // No extra margin, just use .cards gap
            communityCards.appendChild(burnCard);
            // Add a cardback image to the center (after burn card)
            const centerCardback = document.createElement('img');
            centerCardback.className = 'card-img';
            centerCardback.src = "{{ url_for('custom_cards', filename='cardback.jpg') }}";
            centerCardback.alt = 'Cardback';
            communityCards.appendChild(centerCardback);
            // List of all possible card filenames (excluding cardback and cards.png)
            const cardNames = [
                '2 of clubs.png','2 of diamonds.png','2 of hearts.png','2 of spades.png',
                '3 of clubs.png','3 of diamonds.png','3 of hearts.png','3 of spades.png',
                '4 of clubs.png','4 of diamonds.png','4 of hearts.png','4 of spades.png',
                '5 of clubs.png','5 of diamonds.png','5 of hearts.png','5 of spades.png',
                '6 of clubs.png','6 of diamonds.png','6 of hearts.png','6 of spades.png',
                '7 of clubs.png','7 of diamonds.png','7 of hearts.png','7 of spades.png',
                '8 of clubs.png','8 of diamonds.png','8 of hearts.png','8 of spades.png',
                '9 of clubs.png','9 of diamonds.png','9 of hearts.png','9 of spades.png',
                '10 of clubs.png','10 of diamonds.png','10 of hearts.png','10 of spades.png',
                'jack of clubs.png','jack of diamonds.png','jack of hearts.png','jack of spades.png',
                'queen of clubs.png','queen of diamonds.png','queen of hearts.png','queen of spades.png',
                'king of clubs.png','king of diamonds.png','king of hearts.png','king of spades.png',
                'ace of clubs.png','ace of diamonds.png','ace of hearts.png','ace of spades.png'
            ];
            // Shuffle and pick 3 random cards
            const shuffled = cardNames.sort(() => 0.5 - Math.random());
            const selected = shuffled.slice(0, 3);
            for (const card of selected) {
                const img = document.createElement('img');
                img.className = 'card-img';
                img.src = `/static/cards/${card}`;
                img.alt = card.replace('.png', '');
                communityCards.appendChild(img);
            }
            // Hide the Next button after use
            hideNextButton();
        };
        document.getElementById('all-in-btn').onclick = function() {
            var betInput = document.getElementById('player_bet');
            betInput.value = betInput.max;
            document.getElementById('bet-form').requestSubmit();
        };
        document.getElementById('forfeit-btn').onclick = function() {
            fetch('/forfeit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                const statusText = document.getElementById('status-text');
                if (statusText) statusText.textContent = data.message || 'You forfeited the round.';
                document.getElementById('bet-form').style.display = 'none';
            });
        };
    </script>
</body>
</html>
